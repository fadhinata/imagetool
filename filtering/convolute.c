/* Copyright 2011 Hoyoung Yi. This program is free software; you can redistribute it and/or modify it under the terms of the GNU Lesser General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version. This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Lesser General Public License for more details. You should have received a copy of the GNU Lesser General Public License along with this program; if not, please visit www.gnu.org.*/#include <stdio.h>#include <math.h>#include <assert.h>#include <common.h>#include <filtering/convolute.h>#define CONVOLUTE2(type1, q_buf, q_w, q_h, q_p,				\		   type2, p_buf, p_w, p_h, p_p,				\		   type3, k_buf, k_w, k_h, k_p) {			\    int x, y, i, j;							\    int xoff, yoff, w, h;                                               \    int kw, kh;								\    int ppitch, qpitch, kpitch;						\    type1 *qbuf;                                                        \    type2 *pbuf;                                                        \    type3 *kbuf;                                                        \    assert(q_buf);							\    assert(p_buf);							\    assert(k_buf);							\    assert(q_w == p_w);							\    assert(q_h == p_h);							\    assert(k_w < p_w);							\    assert(k_h < p_h);							\    w = p_w, h = p_h;							\    kw = k_w, kh = k_h;							\    ppitch = p_p, qpitch = q_p, kpitch = k_p;				\    xoff = (k_w) >> 1, yoff = (k_h) >> 1;                               \									\    qbuf = (type1 *)(q_buf + yoff * qpitch);				\    for (y = yoff; y < h - (kh - yoff); y++) {				\      for (x = xoff; x < w - (kw - xoff); x++) {                        \        *(qbuf + x) = 0.0;						\        kbuf = (type3 *)(k_buf);                                        \        pbuf = (type2 *)(p_buf + (y - yoff) * ppitch);                  \        for (i = -yoff; i < kh - yoff; i++) {                           \          for (j = -xoff; j < kw - xoff; j++)                           \            *(qbuf + x) += (*(pbuf + (x + j))) * (*(kbuf + (x + j)));   \          kbuf += kpitch;                                               \          pbuf += ppitch;                                               \        }                                                               \      }									\      qbuf += qpitch;							\    }									\									\    qbuf = (type1 *)(q_buf);						\    for (y = 0; y < yoff; y++) {                                        \      for (x = xoff; x < w - (kw - xoff); x++) {                        \        *(qbuf + x) = 0.0;						\        for (i = -yoff; i < kh - yoff; i++) {				\          if ((y + i) < 0) continue;					\          pbuf = (type2 *)(p_buf + (y + i) * ppitch);                   \          kbuf = (type3 *)(k_buf + (i + yoff) * kpitch);                \          for (j = -xoff; j < kw - xoff; j++)				\            *(qbuf + x) += (*(pbuf + (x + j))) * (*(kbuf + (j + xoff))); \        }                                                               \      }									\      qbuf += qpitch;							\    }									\									\    qbuf = (type1 *)(q_buf + (h - (kh - yoff)) * qpitch);               \    for (y = h - (kh - yoff); y < h; y++) {                             \      for (x = xoff; x < w - (kw - xoff); x++) {                        \        *(qbuf + x) = 0.0;						\        pbuf = (type2 *)(p_buf + (y - yoff) * ppitch);                  \        kbuf = (type3 *)(k_buf);                                        \        for (i = -yoff; i < kh-yoff; i++) {				\          if ((y + i) >= h) break;					\          for (j = -xoff; j < kw-xoff; j++)				\            *(qbuf + x) += (*(pbuf + (x + j))) * (*(kbuf + (j + xoff))); \          pbuf += ppitch;                                               \          kbuf += kpitch;                                               \        }                                                               \      }									\      qbuf += qpitch;							\    }									\									\    qbuf = (type1 *)(q_buf + yoff * qpitch);				\    for (y = yoff; y < h - (kh - yoff); y++) {				\      for (x = 0; x < xoff; x++) {					\        *(qbuf + x) = 0.0;						\        pbuf = (type2 *)(p_buf + (y - yoff) * ppitch);			\        kbuf = (type3 *)(k_buf);                                        \        for (i = -yoff; i < kh - yoff; i++) {                           \          for (j = -xoff; j < kw - xoff; j++) {                         \            if ((x + j) < 0) continue;					\            *(qbuf + x) += (*(pbuf + (x + j))) * (*(kbuf + (j + xoff))); \          }								\          pbuf += ppitch;                                               \          kbuf += kpitch;                                               \        }                                                               \      }									\      qbuf += qpitch;							\    }									\									\    qbuf = (type1 *)(q_buf + yoff * qpitch);				\    for (y = yoff; y < h - (kh - yoff); y++) {				\      for (x = w - (kw - xoff); x < w; x++) {				\        *(qbuf + x) = 0.0;						\        pbuf = (type2 *)(p_buf + (y - yoff) * ppitch);			\        kbuf = (type3 *)(k_buf);                                        \        for (i = -yoff; i < kh-yoff; i++) {				\          for (j = -xoff; j < kw-xoff; j++) {				\            if ((x + j) >= w) break;					\            *(qbuf + x) += (*(pbuf + (x + j))) * (*(kbuf + (j + xoff))); \          }								\          pbuf += ppitch;                                               \          kbuf += kpitch;                                               \        }                                                               \      }									\      qbuf += qpitch;							\    }									\									\    qbuf = (type1 *)(q_buf);						\    for (y = 0; y < yoff; y++) {                                        \      for (x = 0; x < xoff; x++) {					\        *(qbuf + x) = 0.0;						\        for (i = -yoff; i < kh - yoff; i++) {				\          if ((y + i) < 0) continue;					\          pbuf = (type2 *)(p_buf + (y + i) * ppitch);                   \          kbuf = (type3 *)(k_buf + (i + yoff) * kpitch);                \          for (j = -xoff; j < kw-xoff; j++) {                           \            if ((x + j) < 0) continue;					\            *(qbuf + x) += (*(pbuf + (x + j))) * (*(kbuf + (j + xoff))); \          }								\        }                                                               \      }									\      qbuf += qpitch;							\    }									\									\    qbuf = (type1 *)(q_buf + (h - (kh - yoff)) * qpitch);               \    for (y = h - (kh - yoff); y < h; y++) {                             \      for (x = 0; x < xoff; x++) {                                      \        *(qbuf + x) = 0.0;                                              \        pbuf = (type2 *)(p_buf + (y - yoff) * ppitch);			\        kbuf = (type3 *)(k_buf);                                        \        for (i = -yoff; i < kh - yoff; i++) {				\          if ((y + i) >= h) break;                                      \          for (j = -xoff; j < kw - xoff; j++) {				\            if ((x + j) < 0) continue;					\            *(qbuf + x) += (*(pbuf + (x + j))) * (*(kbuf + (j + xoff))); \          }								\          pbuf += ppitch;                                               \          kbuf += kpitch;                                               \        }                                                               \      }									\      qbuf += qpitch;							\    }									\                                                                        \    qbuf = (type1 *)q_buf;						\    for (y = 0; y < yoff; y++) {                                        \      for (x = w - (kw - xoff); x < w; x++) {                           \        *(qbuf + x) = 0.0;                                              \        for (i = -yoff; i < kh-yoff; i++) {				\          if ((y + j) < 0) continue;					\          pbuf = (type2 *)(p_buf + (y + i) * ppitch);                   \          kbuf = (type3 *)(k_buf + (i + yoff) * kpitch);                \          for (j = -xoff; j < kw - xoff; j++) {				\            if ((x + j) >= w) break;					\            *(qbuf + x) += (*(pbuf + (x + j))) * (*(kbuf + (j + xoff))); \          }								\        }                                                               \      }									\      qbuf += qpitch;							\    }									\									\    qbuf = (type1 *)(q_buf + (h - (kh - yoff)) * qpitch);               \    for (y = h - (kh - yoff); y < h; y++) {                             \      for (x = w - (kw - xoff); x < w; x++) {                           \        *(qbuf + x) = 0.0;                                              \        pbuf = (type2 *)(p_buf + (y - yoff) * ppitch);                  \        kbuf = (type3 *)(k_buf);                                        \        for (i = -yoff; i < kh - yoff; i++) {				\          if ((y + i) >= h) break;                                      \          for (j = -xoff; j < kw-xoff; j++) {				\            if ((x + j) >= w) break;					\            *(qbuf + x) += (*(pbuf + (x + j))) * (*(kbuf + (j + xoff))); \          }								\          pbuf += ppitch;                                               \          kbuf += kpitch;                                               \        }                                                               \      }									\      qbuf += qpitch;							\    }									\  }void bytemap_convolute2(matrix_t *matrix, bytemap_t *pixmap, matrix_t *kernel){  CONVOLUTE2(real_t,	     matrix_get_buffer(matrix),	     matrix_get_columns(matrix),	     matrix_get_rows(matrix),	     matrix_get_columns(matrix),	     uint8_t,	     bytemap_get_buffer(pixmap),	     bytemap_get_width(pixmap),	     bytemap_get_height(pixmap),	     bytemap_get_pitch(pixmap) / sizeof(uint8_t),	     real_t,	     matrix_get_buffer(kernel),	     matrix_get_columns(kernel),	     matrix_get_rows(kernel),	     matrix_get_columns(kernel));}void wordmap_convolute2(matrix_t *matrix, wordmap_t *pixmap, matrix_t *kernel){  CONVOLUTE2(real_t,	     matrix_get_buffer(matrix),	     matrix_get_columns(matrix),	     matrix_get_rows(matrix),	     matrix_get_columns(matrix),	     uint16_t,	     wordmap_get_buffer(pixmap),	     wordmap_get_width(pixmap),	     wordmap_get_height(pixmap),	     wordmap_get_pitch(pixmap) / sizeof(uint16_t),	     real_t,	     matrix_get_buffer(kernel),	     matrix_get_columns(kernel),	     matrix_get_rows(kernel),	     matrix_get_columns(kernel));}void dwordmap_convolute2(matrix_t *matrix, dwordmap_t *pixmap, matrix_t *kernel){  CONVOLUTE2(real_t,	     matrix_get_buffer(matrix),	     matrix_get_columns(matrix),	     matrix_get_rows(matrix),	     matrix_get_columns(matrix),	     uint32_t,	     dwordmap_get_buffer(pixmap),	     dwordmap_get_width(pixmap),	     dwordmap_get_height(pixmap),	     dwordmap_get_pitch(pixmap) / sizeof(uint32_t),	     real_t,	     matrix_get_buffer(kernel),	     matrix_get_columns(kernel),	     matrix_get_rows(kernel),	     matrix_get_columns(kernel));}void floatmap_convolute2(matrix_t *matrix, floatmap_t *pixmap, matrix_t *kernel){  CONVOLUTE2(real_t,	     matrix_get_buffer(matrix),	     matrix_get_columns(matrix),	     matrix_get_rows(matrix),	     matrix_get_columns(matrix),	     float,	     floatmap_get_buffer(pixmap),	     floatmap_get_width(pixmap),	     floatmap_get_height(pixmap),	     floatmap_get_pitch(pixmap) / sizeof(float),	     real_t,	     matrix_get_buffer(kernel),	     matrix_get_columns(kernel),	     matrix_get_rows(kernel),	     matrix_get_columns(kernel));}void convolute2(matrix_t *q, matrix_t *p, matrix_t *kernel){  CONVOLUTE2(real_t,	     matrix_get_buffer(q),	     matrix_get_columns(q),	     matrix_get_rows(q),	     matrix_get_columns(q),	     real_t,	     matrix_get_buffer(p),	     matrix_get_columns(p),	     matrix_get_rows(p),	     matrix_get_columns(p),	     real_t,	     matrix_get_buffer(kernel),	     matrix_get_columns(kernel),	     matrix_get_rows(kernel),	     matrix_get_columns(kernel));}#if 0#define PIXMAP_CONVOLUTE2(type, mat, map, kernel) {			\    int x, y, i, j;							\    int xoff, yoff, width, height;					\    real_t *matbuf, *kerbuf;						\    type *mapbuf;							\    assert(mat);							\    assert(map);							\    assert(kernel);							\    assert(mat->columns == map->header.width);				\    assert(mat->rows == map->header.height);				\    assert(kernel->columns < map->header.width);			\    assert(kernel->rows < map->header.height);				\    width = map->header.width;						\    height = map->header.height;					\    xoff = kernel->columns>>1;						\    yoff = kernel->rows>>1;						\									\    matbuf = mat->real+yoff*mat->columns;				\    for (y = yoff; y < height-(kernel->rows-yoff); y++) {		\      for (x = xoff; x < width-(kernel->columns-xoff); x++) {		\	*(matbuf+x) = 0.0;						\	kerbuf = kernel->real;						\	mapbuf = map->buffer+(y-yoff)*map->header.pitch/sizeof(*mapbuf)+(x-xoff); \	for (i = 0; i < kernel->rows; i++) {				\	  for (j = 0; j < kernel->columns; j++) {			\	    *(matbuf+x) += (double)(*(mapbuf+j))*(*(kerbuf+j));		\	  }								\	  kerbuf += kernel->columns;					\	  mapbuf += map->header.pitch/sizeof(*mapbuf);			\	}								\      }									\      matbuf += mat->columns;						\    }									\    matbuf = mat->real;							\    for (y = 0; y < yoff; y++) {					\      for (x = xoff; x < width-(kernel->columns-xoff); x++) {		\	*(matbuf+x) = 0.0;						\	for (i = -yoff; i < kernel->rows-yoff; i++) {			\	  if ((y+i) < 0) continue;					\	  mapbuf = map->buffer+(y+i)*map->header.pitch/sizeof(*mapbuf); \	  kerbuf = kernel->real+(i+yoff)*kernel->columns;		\	  for (j = -xoff; j < kernel->columns-xoff; j++) {		\	    *(matbuf+x) += (double)(*(mapbuf+(x+j)))*(*(kerbuf+(j+xoff))); \	  }								\	}								\      }									\      matbuf += mat->columns;						\    }									\    matbuf = mat->real+(height-(kernel->rows-yoff))*mat->columns;	\    for (y = height-(kernel->rows-yoff); y < height; y++) {		\      for (x = xoff; x < width-(kernel->columns-xoff); x++) {		\	*(matbuf+x) = 0.0;						\	for (i = -yoff; i < kernel->rows-yoff; i++) {			\	  if ((y+i) >= height) break;					\	  mapbuf = map->buffer+(y+i)*map->header.pitch/sizeof(*mapbuf); \	  kerbuf = kernel->real+(i+yoff)*kernel->columns;		\	  for (j = -xoff; j < kernel->columns-xoff; j++) {		\	    *(matbuf+x) += (double)(*(mapbuf+(x+j)))*(*(kerbuf+(j+xoff))); \	  }								\	}								\      }									\      matbuf += mat->columns;						\    }									\    matbuf = mat->real+yoff*mat->columns;				\    for (y = yoff; y < height-(kernel->rows-yoff); y++) {		\      for (x = 0; x < xoff; x++) {					\	*(matbuf+x) = 0.0;						\	mapbuf = map->buffer+(y-yoff)*map->header.pitch/sizeof(*mapbuf); \	kerbuf = kernel->real;						\	for (i = -yoff; i < kernel->rows-yoff; i++) {			\	  for (j = -xoff; j < kernel->columns-xoff; j++) {		\	    if ((x+j) < 0) continue;					\	    *(matbuf+x) += (double)(*(mapbuf+(x+j)))*(*(kerbuf+(j+xoff))); \	  }								\	  mapbuf += map->header.pitch/sizeof(*mapbuf);			\	  kerbuf += kernel->columns;					\	}								\      }									\      matbuf += mat->columns;						\    }									\    matbuf = mat->real+yoff*mat->columns;				\    for (y = yoff; y < height-(kernel->rows-yoff); y++) {		\      for (x = width-(kernel->columns-xoff); x < width; x++) {		\	*(matbuf+x) = 0.0;						\	mapbuf = map->buffer+(y-yoff)*map->header.pitch/sizeof(*mapbuf); \	kerbuf = kernel->real;						\	for (i = -yoff; i < kernel->rows-yoff; i++) {			\	  for (j = -xoff; j < kernel->columns-xoff; j++) {		\	    if ((x+j) >= width) break;					\	    *(matbuf+x) += (double)(*(mapbuf+(x+j)))*(*(kerbuf+(j+xoff))); \	  }								\	  mapbuf += map->header.pitch/sizeof(*mapbuf);			\	  kerbuf += kernel->columns;					\	}								\      }									\      matbuf += mat->columns;						\    }									\    matbuf = mat->real;							\    for (y = 0; y < yoff; y++) {					\      for (x = 0; x < xoff; x++) {					\	*(matbuf+x) = 0.0;						\	for (i = -yoff; i < kernel->rows-yoff; i++) {			\	  if ((y+i) < 0) continue;					\	  for (j = -xoff; j < kernel->columns-xoff; j++) {		\	    if ((x+j) < 0) continue;					\	    *(matbuf+x) += (double)(*(map->buffer+(y+i)*map->header.pitch/sizeof(*(map->buffer))+(x+j))) \	      *(*(kernel->real+(i+yoff)*kernel->columns+(j+xoff)));	\	  }								\	}								\      }									\      matbuf += mat->columns;						\    }									\    matbuf = mat->real+(height-(kernel->rows-yoff))*mat->columns;	\    for (y = height-(kernel->rows-yoff); y < height; y++) {		\      for (x = 0; x < xoff; x++) {					\	*(matbuf+x) = 0.0;						\	for (i = -yoff; i < kernel->rows-yoff; i++) {			\	  if ((y+i) >= height) break;					\	  for (j = -xoff; j < kernel->columns-xoff; j++) {		\	    if ((x+j) < 0) continue;					\	    *(matbuf+x) += (double)(*(map->buffer+(y+i)*map->header.pitch/sizeof(*(map->buffer))+(x+j))) \	      *(*(kernel->real+(i+yoff)*kernel->columns+(j+xoff)));	\	  }								\	}								\      }									\      matbuf += mat->columns;						\    }									\    matbuf = mat->real;							\    for (y = 0; y < yoff; y++) {					\      for (x = width-(kernel->columns-xoff); x < width; x++) {		\	*(matbuf+x) = 0.0;						\	for (i = -yoff; i < kernel->rows-yoff; i++) {			\	  if ((y+j) < 0) continue;					\	  for (j = -xoff; j < kernel->columns-xoff; j++) {		\	    if ((x+j) >= width) break;					\	    *(matbuf+x) += (double)(*(map->buffer+(y+i)*map->header.pitch/sizeof(*(map->buffer))+(x+j))) \	      *(*(kernel->real+(i+yoff)*kernel->columns+(j+xoff)));	\	  }								\	}								\      }									\      matbuf += mat->columns;						\    }									\    matbuf = mat->real+(height-(kernel->rows-yoff))*mat->columns;	\    for (y = height-(kernel->rows-yoff); y < height; y++) {		\      for (x = width-(kernel->columns-xoff); x < width; x++) {		\	*(matbuf+x) = 0.0;						\	for (i = -yoff; i < kernel->rows-yoff; i++) {			\	  if ((y+i) >= height) break;					\	  for (j = -xoff; j < kernel->columns-xoff; j++) {		\	    if ((x+j) >= width) break;					\	    *(matbuf+x) += (double)(*(map->buffer+(y+i)*map->header.pitch/sizeof(*(map->buffer))+(x+j))) \	      *(*(kernel->real+(i+yoff)*kernel->columns+(j+xoff)));	\	  }								\	}								\      }									\      matbuf += mat->columns;						\    }									\  }#endif